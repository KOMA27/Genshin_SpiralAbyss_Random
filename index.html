<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>深境螺旋 抽選ツール</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>
  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
</div>

<div class="center">
  <button id="drawBtn">8人抽選</button>
  <button id="resetTeamBtn" class="reset-btn">編成リセット</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>抽選結果</h2>
    <div id="pool" class="list"></div>
  </div>
  <div class="box">
    <h2>前半</h2>
    <div id="teamA" class="list"></div>
  </div>
  <div class="box">
    <h2>後半</h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<div class="owned-header">
  <h2>キャラ所持設定</h2>
  <button id="resetOwnedBtn" class="reset-btn small">所持設定リセット</button>
</div>
<div id="grid" class="character-grid"></div>

<div class="history">
  <h2>抽選履歴</h2>
  <div id="history" class="history-grid"></div>
</div>

<script>
// =====================
// JavaScript（JSを必ず動かす）
fetch('./characters.json')
  .then(r=>r.json())
  .then(data => {
    window.characters = data;
    window.owned = new Set(data.map(c=>c.name));
    renderGrid();
    restoreFromURL();
    renderHistory();
  })
  .catch(e=>{
    console.error('characters.json 読み込みエラー', e);
  });

function icon(n){return `./icon/${n}_s.webp`;}

// 所持キャラ
function renderGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  window.characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char';
    d.innerHTML = `<img src="${icon(c.name)}"><span>${c.name}</span>`;
    d.onclick=()=>{
      if(window.owned.has(c.name)) window.owned.delete(c.name);
      else window.owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...window.owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

function createCard(name){
  const d=document.createElement('div');
  d.className='card';
  d.draggable=true;
  d.innerHTML = `<img src="${icon(name)}"><span>${name}</span>`;
  d.ondragstart=()=>window.dragCard=d;
  d.ondragend=()=>window.dragCard=null;
  return d;
}

// 抽選
document.getElementById('drawBtn').onclick = async ()=>{
  ['pool','teamA','teamB'].forEach(id=>{
    document.getElementById(id).innerHTML='';
  });
  const els=[...document.querySelectorAll('.el:checked')].map(e=>e.value);
  const base = window.characters.filter(c=>
    window.owned.has(c.name) && els.includes(c.element)
  );
  if(base.length<8){alert('8人未満');return;}
  const result = shuffle(base).slice(0,8).map(c=>c.name);

  const poolEl = document.getElementById('pool');
  poolEl.innerHTML = '';
  result.forEach(n=>poolEl.appendChild(createCard(n)));

  saveHistory(result);
  updateURL(result);
};

// D&D
['pool','teamA','teamB'].forEach(id=>{
  const list = document.getElementById(id);
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault();
    if(!window.dragCard) return;
    if(list!==document.getElementById('pool') && list.children.length>=4){
      alert('4人まで');return;
    }
    list.appendChild(window.dragCard);
  };
});

// 履歴
function saveHistory(arr){
  let h = JSON.parse(localStorage.getItem('history')||'[]');
  h.unshift({arr,time:Date.now()});
  h=h.slice(0,10);
  localStorage.setItem('history',JSON.stringify(h));
  renderHistory();
}
function renderHistory(){
  const historyEl=document.getElementById('history');
  historyEl.innerHTML='';
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  h.forEach(x=>{
    const d=document.createElement('div');
    d.className='history-item';
    d.onclick=()=>{restore(arr)};
    d.innerHTML = `
      <div class="history-time">${new Date(x.time).toLocaleString()}</div>
      <div class="history-icons">
        ${x.arr.map(n=>`<img src="${icon(n)}">`).join('')}
      </div>`;
    historyEl.appendChild(d);
  });
}
function restore(arr){
  ['pool','teamA','teamB'].forEach(id=>document.getElementById(id).innerHTML='');
  arr.forEach(n=>document.getElementById('pool').appendChild(createCard(n)));
  updateURL(arr);
}

// URL
function updateURL(arr){
  history.replaceState(null,'','?p='+arr.join(','));
}
function restoreFromURL(){
  const q=new URLSearchParams(location.search);
  if(q.has('p')){
    const arr=q.get('p').split(',');
    arr.forEach(n=>document.getElementById('pool').appendChild(createCard(n)));
  }
}
function shuffle(a){return [...a].sort(()=>Math.random()-0.5);}
</script>

</body>
</html>
