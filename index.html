<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åŸç¥ èºæ—‹ãƒ©ãƒ³ãƒ€ãƒ ç·¨æˆ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1>èºæ—‹12å±¤ ãƒ©ãƒ³ãƒ€ãƒ ç·¨æˆ</h1>

<!-- æ‰€æŒã‚­ãƒ£ãƒ© -->
<section>
  <h2>æ‰€æŒã‚­ãƒ£ãƒ©</h2>
  <div id="characterGrid" class="character-grid"></div>
  <button id="resetOwned" class="sub-btn">æ‰€æŒã‚­ãƒ£ãƒ©ãƒªã‚»ãƒƒãƒˆ</button>
</section>

<!-- æŠ½é¸ -->
<section class="center">
  <button id="drawBtn">æŠ½é¸</button>
</section>

<!-- æŠ½é¸çµæœ -->
<section class="drag-area">
  <div class="box">
    <h2>
      å‰åŠ
      <button class="lock-btn" data-side="a">ğŸ”“</button>
    </h2>
    <div id="teamA" class="list"></div>
  </div>

  <div class="box">
    <h2>
      å¾ŒåŠ
      <button class="lock-btn" data-side="b">ğŸ”“</button>
    </h2>
    <div id="teamB" class="list"></div>
  </div>
</section>

<!-- æŠ½é¸å±¥æ­´ -->
<section>
  <div class="history-header">
    <h2>æŠ½é¸å±¥æ­´ï¼ˆ8äººï¼‰</h2>
    <button id="resetHistory" class="sub-btn">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div id="history" class="history-grid"></div>
</section>

<script>
/* =========================
   ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ï¼ˆç°¡æ˜“ï¼‰
========================= */
const characters = [
  "èƒ¡æ¡ƒ","å¤œè˜­","é¾é›¢","é›·é›»å°†è»","ãƒŠãƒ’ãƒ¼ãƒ€","ä¸‡è‘‰","ãƒ•ãƒªãƒ¼ãƒŠ","ã‚¢ãƒ«ãƒã‚¤ã‚¼ãƒ³",
  "ç”˜é›¨","ç”³é¶´","è¡Œç§‹","é¦™è±","ãƒ™ãƒãƒƒãƒˆ","å¿","ãƒ•ã‚£ãƒƒã‚·ãƒ¥ãƒ«","ã‚¹ã‚¯ãƒ­ãƒ¼ã‚¹"
].map(n => ({ name:n }));

/* =========================
   çŠ¶æ…‹
========================= */
let owned = JSON.parse(localStorage.getItem("owned") || "[]");
let history = JSON.parse(localStorage.getItem("abyssHistory") || "[]");

let teamA = [];
let teamB = [];

let lockA = false;
let lockB = false;

/* =========================
   åˆæœŸæç”»
========================= */
const grid = document.getElementById("characterGrid");

function renderOwned() {
  grid.innerHTML = "";
  characters.forEach(c => {
    const div = document.createElement("div");
    div.className = "char " + (owned.includes(c.name) ? "" : "off");
    div.innerHTML = `
      <img src="./icon/${c.name}_s.webp">
      <span>${c.name}</span>
    `;
    div.onclick = () => {
      owned = owned.includes(c.name)
        ? owned.filter(n => n !== c.name)
        : [...owned, c.name];
      localStorage.setItem("owned", JSON.stringify(owned));
      renderOwned();
    };
    grid.appendChild(div);
  });
}
renderOwned();

/* =========================
   æŠ½é¸
========================= */
document.getElementById("drawBtn").onclick = async () => {
  if (owned.length < 8) {
    alert("æ‰€æŒã‚­ãƒ£ãƒ©ãŒ8äººæœªæº€ã§ã™");
    return;
  }

  teamA = lockA ? teamA : [];
  teamB = lockB ? teamB : [];

  const pool = owned.filter(n =>
    !teamA.includes(n) && !teamB.includes(n)
  );

  shuffle(pool);

  const result = pool.slice(0, 8 - teamA.length - teamB.length);

  const all = [...teamA, ...teamB, ...result];

  history.unshift({
    time: new Date().toLocaleString(),
    chars: all
  });
  history = history.slice(0, 10);
  localStorage.setItem("abyssHistory", JSON.stringify(history));
  renderHistory();

  let idx = 0;
  for (const name of result) {
    await sleep(300);
    if (!lockA && teamA.length < 4) {
      teamA.push(name);
    } else if (!lockB && teamB.length < 4) {
      teamB.push(name);
    }
    renderTeams();
  }
};

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

/* =========================
   ãƒãƒ¼ãƒ æç”» + DnD
========================= */
function renderTeams(){
  renderList("teamA", teamA, lockA);
  renderList("teamB", teamB, lockB);

  // è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
  if (teamA.length === 4 && teamB.length < 4 && !lockB) {
    const rest = teamA.length + teamB.length;
    if (rest === 8) return;
  }
}

function renderList(id, arr, locked){
  const el = document.getElementById(id);
  el.innerHTML = "";
  arr.forEach((n,i)=>{
    const d=document.createElement("div");
    d.className="card";
    d.draggable=!locked;
    d.innerHTML=`<img src="./icon/${n}_s.webp"><span>${n}</span>`;
    d.ondragstart=e=>{
      e.dataTransfer.setData("text",`${id},${i}`);
    };
    el.appendChild(d);
  });

  el.ondragover=e=>e.preventDefault();
  el.ondrop=e=>{
    if(locked) return;
    const [from,idx]=e.dataTransfer.getData("text").split(",");
    const src = from==="teamA"?teamA:teamB;
    const dst = id==="teamA"?teamA:teamB;
    if(dst.length>=4) return alert("4äººã¾ã§ã§ã™");
    dst.push(src.splice(idx,1)[0]);
    renderTeams();
  };
}

/* =========================
   ãƒ­ãƒƒã‚¯
========================= */
document.querySelectorAll(".lock-btn").forEach(btn=>{
  btn.onclick=()=>{
    if(btn.dataset.side==="a"){
      lockA=!lockA;
      btn.textContent=lockA?"ğŸ”’":"ğŸ”“";
    }else{
      lockB=!lockB;
      btn.textContent=lockB?"ğŸ”’":"ğŸ”“";
    }
    renderTeams();
  };
});

/* =========================
   å±¥æ­´
========================= */
function renderHistory(){
  const h=document.getElementById("history");
  h.innerHTML="";
  history.forEach(e=>{
    const d=document.createElement("div");
    d.className="history-item";
    d.innerHTML=`
      <div class="time">${e.time}</div>
      <div class="icons">
        ${e.chars.map(n=>`<img src="./icon/${n}_s.webp">`).join("")}
      </div>
    `;
    h.appendChild(d);
  });
}
renderHistory();

/* =========================
   ãƒªã‚»ãƒƒãƒˆ
========================= */
document.getElementById("resetOwned").onclick=()=>{
  owned=[];
  localStorage.removeItem("owned");
  renderOwned();
};

document.getElementById("resetHistory").onclick=()=>{
  history=[];
  localStorage.removeItem("abyssHistory");
  renderHistory();
};

const sleep = ms => new Promise(r=>setTimeout(r,ms));
</script>
</body>
</html>
