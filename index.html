<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åŸç¥ æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1>æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</h1>

<!-- æ‰€æŒã‚­ãƒ£ãƒ© -->
<section>
  <h2>æ‰€æŒã‚­ãƒ£ãƒ©é¸æŠ</h2>
  <div class="center">
    <button id="resetOwned" class="sub-btn">æ‰€æŒã‚­ãƒ£ãƒ©ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div id="ownedList" class="character-grid"></div>
</section>

<!-- æŠ½é¸ -->
<section class="center">
  <button id="drawBtn">æŠ½é¸</button>
  <button id="resetHistoryBtn" class="sub-btn">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
</section>

<!-- æŠ½é¸çµæœ -->
<section class="drag-area">
  <div class="box">
    <h2>
      å‰åŠ
      <button class="lock-btn" id="lockA">ğŸ”“</button>
    </h2>
    <div id="teamA" class="list"></div>
  </div>

  <div class="box">
    <h2>
      å¾ŒåŠ
      <button class="lock-btn" id="lockB">ğŸ”“</button>
    </h2>
    <div id="teamB" class="list"></div>
  </div>
</section>

<!-- å±¥æ­´ -->
<section>
  <h2>æŠ½é¸å±¥æ­´</h2>
  <div id="history" class="history-grid"></div>
</section>

<script>
let characters = [];
let owned = {};
let currentTeamA = [];
let currentTeamB = [];
let lockA = false;
let lockB = false;

fetch("characters.json")
  .then(r => r.json())
  .then(data => {
    characters = data;
    loadOwned();
    renderOwned();
    loadFromURL();
    renderHistory();
  });

function loadOwned(){
  const saved = JSON.parse(localStorage.getItem("owned") || "null");
  if(saved){
    owned = saved;
  }else{
    characters.forEach(c => owned[c.name] = true);
    localStorage.setItem("owned", JSON.stringify(owned));
  }
}

function renderOwned(){
  const el = document.getElementById("ownedList");
  el.innerHTML = "";
  characters.forEach(c => {
    const d = document.createElement("div");
    d.className = "char" + (owned[c.name] ? "" : " off");
    d.innerHTML = `
      <img src="./icon/${c.icon}_s.webp">
      <span>${c.name}</span>
    `;
    d.onclick = () => {
      owned[c.name] = !owned[c.name];
      localStorage.setItem("owned", JSON.stringify(owned));
      renderOwned();
    };
    el.appendChild(d);
  });
}

document.getElementById("resetOwned").onclick = () => {
  characters.forEach(c => owned[c.name] = true);
  localStorage.setItem("owned", JSON.stringify(owned));
  renderOwned();
};

function draw(){
  document.getElementById("drawBtn").disabled = true;

  const pool = characters.filter(c => owned[c.name]);
  if(pool.length < 8){
    alert("æ‰€æŒã‚­ãƒ£ãƒ©ãŒ8äººæœªæº€ã§ã™");
    document.getElementById("drawBtn").disabled = false;
    return;
  }

  const shuffled = [...pool].sort(() => Math.random() - 0.5);
  const result = shuffled.slice(0, 8);

  let i = 0;
  const temp = [];

  const timer = setInterval(() => {
    temp.push(result[i]);
    renderTemp(temp);
    i++;
    if(i === 8){
      clearInterval(timer);
      applyResult(result);
      saveHistory(result);
      document.getElementById("drawBtn").disabled = false;
    }
  }, 300);
}

function renderTemp(list){
  const a = document.getElementById("teamA");
  const b = document.getElementById("teamB");
  a.innerHTML = "";
  b.innerHTML = "";
  list.forEach((c,i)=>{
    const card = createCard(c);
    (i<4 ? a : b).appendChild(card);
  });
}

function applyResult(result){
  let a = lockA ? [...currentTeamA] : [];
  let b = lockB ? [...currentTeamB] : [];

  const rest = result.filter(c => !a.includes(c) && !b.includes(c));

  if(!lockA) a.push(...rest.splice(0, 4 - a.length));
  if(!lockB) b.push(...rest.splice(0, 4 - b.length));

  currentTeamA = a;
  currentTeamB = b;
  renderTeams(a,b);
  updateURL(result);
}

function renderTeams(a,b){
  const A = document.getElementById("teamA");
  const B = document.getElementById("teamB");
  A.innerHTML = "";
  B.innerHTML = "";
  a.forEach(c => A.appendChild(createCard(c)));
  b.forEach(c => B.appendChild(createCard(c)));
}

function createCard(c){
  const d = document.createElement("div");
  d.className = "card";
  d.draggable = true;
  d.innerHTML = `<img src="./icon/${c.icon}_s.webp"><span>${c.name}</span>`;
  return d;
}

document.getElementById("drawBtn").onclick = draw;

document.getElementById("lockA").onclick = () => {
  lockA = !lockA;
  lockAEl();
};
document.getElementById("lockB").onclick = () => {
  lockB = !lockB;
  lockBEl();
};

function lockAEl(){
  const b = document.getElementById("lockA");
  b.textContent = lockA ? "ğŸ”’" : "ğŸ”“";
  b.classList.toggle("locked", lockA);
}
function lockBEl(){
  const b = document.getElementById("lockB");
  b.textContent = lockB ? "ğŸ”’" : "ğŸ”“";
  b.classList.toggle("locked", lockB);
}

function saveHistory(result){
  const h = JSON.parse(localStorage.getItem("history") || "[]");
  h.unshift({time:Date.now(), result});
  localStorage.setItem("history", JSON.stringify(h.slice(0,20)));
  renderHistory();
}

function renderHistory(){
  const el = document.getElementById("history");
  el.innerHTML = "";
  const h = JSON.parse(localStorage.getItem("history") || "[]");
  h.forEach(x=>{
    const d = document.createElement("div");
    d.className = "history-item";
    const date = new Date(x.time).toLocaleString();
    d.innerHTML = `<div class="history-time">${date}</div>`;
    x.result.forEach(c=>{
      d.innerHTML += `<img src="./icon/${c.icon}_s.webp">`;
    });
    el.appendChild(d);
  });
}

document.getElementById("resetHistoryBtn").onclick = ()=>{
  if(confirm("æŠ½é¸å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("history");
    renderHistory();
  }
};

function updateURL(result){
  const names = result.map(c=>encodeURIComponent(c.name)).join(",");
  history.replaceState(null,"",`?r=${names}`);
}

function loadFromURL(){
  const p = new URLSearchParams(location.search);
  if(!p.has("r")) return;
  const names = decodeURIComponent(p.get("r")).split(",");
  const r = names.map(n => characters.find(c=>c.name===n)).filter(Boolean);
  if(r.length===8) applyResult(r);
}
</script>

</body>
</html>
