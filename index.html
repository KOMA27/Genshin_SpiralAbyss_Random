<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>

  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
</div>

<div class="center">
  <button id="drawBtn">8人抽選</button>
  <button class="reset-btn" id="resetBtn">リセット</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>抽選結果</h2>
    <div id="pool" class="list"></div>
  </div>
  <div class="box">
    <h2>前半</h2>
    <div id="teamA" class="list"></div>
  </div>
  <div class="box">
    <h2>後半</h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<h2 class="sub">キャラ所持設定</h2>
<div id="grid" class="character-grid"></div>

<script>
/* ========= グローバル ========= */
let characters = [];
let owned = new Set();

/* ========= DOM ========= */
const pool = document.getElementById('pool');
const teamA = document.getElementById('teamA');
const teamB = document.getElementById('teamB');
const grid = document.getElementById('grid');

/* ========= JSON 読み込み ========= */
fetch('./characters.json')
  .then(res => {
    if (!res.ok) throw new Error('characters.json が見つかりません');
    return res.json();
  })
  .then(data => {
    if (!Array.isArray(data)) throw new Error('characters.json は配列形式である必要があります');
    characters = data;

    const saved = JSON.parse(localStorage.getItem('owned') || '[]');
    owned = new Set(saved.length ? saved : characters.map(c => c.name));

    renderGrid();
  })
  .catch(err => {
    alert(err.message);
    console.error(err);
  });

/* ========= 共通 ========= */
function icon(c){
  return `./icon/${c.name}_s.webp`;
}

/* ========= キャラ一覧 ========= */
function renderGrid(){
  grid.innerHTML = '';
  characters.forEach(c => {
    const d = document.createElement('div');
    d.className = 'char' + (owned.has(c.name) ? '' : ' off');
    d.innerHTML = `<img src="${icon(c)}"><span>${c.name}</span>`;
    d.onclick = () => {
      owned.has(c.name) ? owned.delete(c.name) : owned.add(c.name);
      localStorage.setItem('owned', JSON.stringify([...owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

/* ========= 抽選 ========= */
document.getElementById('drawBtn').onclick = async () => {
  pool.innerHTML = teamA.innerHTML = teamB.innerHTML = '';

  const r4 = document.getElementById('r4').checked;
  const r5 = document.getElementById('r5').checked;
  const els = [...document.querySelectorAll('.el:checked')].map(e => e.value);

  const base = characters.filter(c =>
    owned.has(c.name) &&
    els.includes(c.element) &&
    ((c.rarity === 4 && r4) || (c.rarity === 5 && r5))
  );

  if (base.length < 8) {
    alert('抽選対象が8人未満です');
    return;
  }

  /* 抽選演出 */
  for (let i = 0; i < 12; i++) {
    pool.innerHTML = '';
    shuffle(base).slice(0, 8).forEach(c => {
      const d = document.createElement('div');
      d.className = 'card shuffling';
      d.innerHTML = `<img src="${icon(c)}">${c.name}`;
      pool.appendChild(d);
    });
    await sleep(80);
  }

  /* 確定 */
  pool.innerHTML = '';
  shuffle(base).slice(0, 8).forEach(c => {
    pool.appendChild(createCard(c));
  });
};

/* ========= リセット ========= */
document.getElementById('resetBtn').onclick = () => {
  owned = new Set(characters.map(c => c.name));
  localStorage.removeItem('owned');
  pool.innerHTML = teamA.innerHTML = teamB.innerHTML = '';
  renderGrid();
};

/* ========= D&D ========= */
function createCard(c){
  const d = document.createElement('div');
  d.className = 'card';
  d.draggable = true;
  d.ondragstart = e => e.dataTransfer.setData('text', c.name);
  d.innerHTML = `<img src="${icon(c)}">${c.name}`;
  return d;
}

document.querySelectorAll('.list').forEach(list => {
  list.ondragover = e => e.preventDefault();
  list.ondrop = e => {
    e.preventDefault();
    const name = e.dataTransfer.getData('text');
    const card = [...document.querySelectorAll('.card')].find(c => c.textContent === name);
    if (!card) return;

    if (list !== pool && list.children.length >= 4) {
      alert('4人までです');
      return;
    }
    list.appendChild(card);

    if (teamA.children.length === 4) [...pool.children].forEach(c => teamB.appendChild(c));
    if (teamB.children.length === 4) [...pool.children].forEach(c => teamA.appendChild(c));
  };
});

/* ========= util ========= */
function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>

</body>
</html>
