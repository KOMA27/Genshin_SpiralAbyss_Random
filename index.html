<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åŸç¥ æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>â˜…4</label>
  <label><input type="checkbox" id="r5" checked>â˜…5</label>

  <label><input type="checkbox" class="el" value="ç‚" checked>ç‚</label>
  <label><input type="checkbox" class="el" value="æ°´" checked>æ°´</label>
  <label><input type="checkbox" class="el" value="é›·" checked>é›·</label>
  <label><input type="checkbox" class="el" value="æ°·" checked>æ°·</label>
  <label><input type="checkbox" class="el" value="é¢¨" checked>é¢¨</label>
  <label><input type="checkbox" class="el" value="å²©" checked>å²©</label>
  <label><input type="checkbox" class="el" value="è‰" checked>è‰</label>
</div>

<div class="center">
  <button id="drawBtn">æŠ½é¸</button>
  <button class="reset-btn" id="resetTeamBtn">ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>æŠ½é¸çµæœ</h2>
    <div id="pool" class="list"></div>
  </div>

  <div class="box" id="boxA">
    <h2>å‰åŠ <span id="lockA" class="lock">ğŸ”“</span></h2>
    <div id="teamA" class="list"></div>
  </div>

  <div class="box" id="boxB">
    <h2>å¾ŒåŠ <span id="lockB" class="lock">ğŸ”“</span></h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<div class="owned-header">
  <h2 class="sub">ã‚­ãƒ£ãƒ©æ‰€æŒè¨­å®š</h2>
  <div class="center">
    <button class="reset-btn small" id="resetOwnedBtn">æ‰€æŒè¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>
<div id="grid" class="character-grid"></div>

<div class="history">
  <h2>æŠ½é¸å±¥æ­´</h2>
  <div id="history"></div>
</div>

<script>
let characters=[];
let owned=new Set();
let dragCard=null;
let lockTeamA=false;
let lockTeamB=false;

const pool=document.getElementById('pool');
const teamA=document.getElementById('teamA');
const teamB=document.getElementById('teamB');
const boxA=document.getElementById('boxA');
const boxB=document.getElementById('boxB');
const grid=document.getElementById('grid');
const historyEl=document.getElementById('history');

const icon=n=>`./icon/${n}_s.webp`;

/* ===== åˆæœŸåŒ– ===== */
fetch('./characters.json')
.then(r=>r.json())
.then(data=>{
  characters=data;
  const saved=JSON.parse(localStorage.getItem('owned')||'[]');
  owned=new Set(saved.length?saved:characters.map(c=>c.name));
  renderGrid();
  restoreFromURL();
  renderHistory();
});

/* ===== æ‰€æŒè¨­å®š ===== */
function renderGrid(){
  grid.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char'+(owned.has(c.name)?'':' off');
    d.innerHTML=`<img src="${icon(c.name)}"><span>${c.name}</span>`;
    d.onclick=()=>{
      owned.has(c.name)?owned.delete(c.name):owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
function createCard(name){
  const d=document.createElement('div');
  d.className='card';
  d.innerHTML=`<img src="${icon(name)}"><span>${name}</span>`;
  d.draggable=true;
  d.ondragstart=()=>dragCard=d;
  d.ondragend=()=>dragCard=null;
  return d;
}

/* ===== ã‚¹ãƒ­ãƒƒãƒˆæ¼”å‡ºï¼ˆæŠ½é¸åˆ†ã®ã¿ï¼‰ ===== */
function slotDraw(drawNames, onComplete){
  pool.innerHTML='';
  const slots=[];
  const timers=[];

  drawNames.forEach((_,i)=>{
    const c=createCard(drawNames[0]);
    c.classList.add('shuffling');
    pool.appendChild(c);
    slots.push(c);

    timers[i]=setInterval(()=>{
      const r=characters[Math.floor(Math.random()*characters.length)].name;
      c.querySelector('img').src=icon(r);
      c.querySelector('span').textContent=r;
    },80);
  });

  drawNames.forEach((name,i)=>{
    setTimeout(()=>{
      clearInterval(timers[i]);
      slots[i].classList.remove('shuffling');
      slots[i].querySelector('img').src=icon(name);
      slots[i].querySelector('span').textContent=name;
      if(i===drawNames.length-1 && onComplete) onComplete();
    },800*(i+1));
  });
}

/* ===== æŠ½é¸ ===== */
drawBtn.onclick=()=>{
  const els=[...document.querySelectorAll('.el:checked')].map(e=>e.value);

  pool.innerHTML='';
  if(!lockTeamA) teamA.innerHTML='';
  if(!lockTeamB) teamB.innerHTML='';

  const fixed=[
    ...(lockTeamA?[...teamA.children].map(c=>c.innerText):[]),
    ...(lockTeamB?[...teamB.children].map(c=>c.innerText):[])
  ];

  const base=characters.filter(c=>
    owned.has(c.name)&&
    els.includes(c.element)&&
    ((c.rarity===4&&r4.checked)||(c.rarity===5&&r5.checked))&&
    !fixed.includes(c.name)
  );

  const need=8-fixed.length;
  if(need<=0) return;

  if(base.length<need){
    alert('æŠ½é¸å¯¾è±¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    return;
  }

  const draw=shuffle(base).slice(0,need).map(c=>c.name);
  const result=[...fixed,...draw];

  slotDraw(draw,()=>{
    saveHistory(result);
    updateURL(result);
  });
};

/* ===== D&D / ãƒ­ãƒƒã‚¯ / å±¥æ­´ / ãƒªã‚»ãƒƒãƒˆ ===== */
/* ï¼ˆä»¥ä¸‹ã¯å…ƒã‚³ãƒ¼ãƒ‰ã‹ã‚‰ä¸€åˆ‡å¤‰æ›´ãªã—ï¼‰ */

const shuffle=a=>[...a].sort(()=>Math.random()-0.5);
</script>

</body>
</html>
