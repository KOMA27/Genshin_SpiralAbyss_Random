<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<style>
body{font-family:sans-serif;background:#f6f6f6;padding:20px}
h1{text-align:center}
button{padding:8px 16px;font-size:15px;cursor:pointer;margin:6px}
.filters{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px}
.filters label{background:#fff;padding:6px 10px;border-radius:6px}

h2{margin-top:30px;border-bottom:2px solid #333}

.character-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,80px);
  gap:12px;
  margin:10px 0
}
.char{text-align:center;cursor:pointer}
.char img{width:72px;height:72px;border-radius:10px}
.char.off img{filter:grayscale(100%) brightness(60%)}
.char span{font-size:11px}

.drag-area{
  display:flex;
  gap:20px;
  margin-top:20px
}
.box{
  background:#fff;
  padding:10px;
  border-radius:10px;
  width:33%
}
.box h3{text-align:center}
.list{
  min-height:120px;
  border:2px dashed #aaa;
  border-radius:8px;
  padding:8px;
  display:grid;
  grid-template-columns:repeat(auto-fill,120px);
  gap:6px
}
.card{
  display:flex;
  align-items:center;
  background:#eee;
  padding:4px;
  border-radius:6px;
  cursor:grab
}
.card img{
  width:40px;height:40px;border-radius:6px;margin-right:6px
}
</style>
</head>
<body>

<h1>原神 深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>
  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
</div>

<div style="text-align:center">
  <button onclick="draw()">8人抽選</button>
</div>

<div id="gridArea"></div>

<div class="drag-area">
  <div class="box">
    <h3>抽選結果</h3>
    <div id="pool" class="list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
  <div class="box">
    <h3>チームA（4人）</h3>
    <div id="teamA" class="list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
  <div class="box">
    <h3>チームB（4人）</h3>
    <div id="teamB" class="list" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
  </div>
</div>

<script>
const ICON_DIR='./icon/';
let characters=[];
let owned=new Set();
let dragId=null;

fetch('characters.json')
.then(r=>r.json())
.then(data=>{
  characters=data;
  owned=new Set(JSON.parse(localStorage.getItem('owned')) ?? characters.map(c=>c.name));
  renderGrid();
});

function img(name){return ICON_DIR+name+'_s.webp';}
function save(){localStorage.setItem('owned',JSON.stringify([...owned]));}
function allowDrop(e){e.preventDefault();}
function drag(e){dragId=e.target.id;}
function drop(e){
  e.preventDefault();
  const el=document.getElementById(dragId);
  if(el) e.currentTarget.appendChild(el);
}

function renderGrid(){
  const area=document.getElementById('gridArea');
  area.innerHTML='';
  const nations=[...new Set(characters.map(c=>c.nation))];
  nations.forEach(n=>{
    const h=document.createElement('h2');h.textContent=n;
    const g=document.createElement('div');g.className='character-grid';
    characters.filter(c=>c.nation===n).forEach(c=>{
      const d=document.createElement('div');
      d.className='char'+(owned.has(c.name)?'':' off');
      d.onclick=()=>{
        owned.has(c.name)?owned.delete(c.name):owned.add(c.name);
        save();renderGrid();
      };
      d.innerHTML=`<img src="${img(c.name)}"><span>${c.name}</span>`;
      g.appendChild(d);
    });
    area.append(h,g);
  });
}

function draw(){
  const els=[...document.querySelectorAll('.el:checked')].map(e=>e.value);
  const r4=r4El.checked,r5=r5El.checked;
  const pool=characters.filter(c=>
    owned.has(c.name)&&els.includes(c.element)&&
    ((c.rarity===4&&r4)||(c.rarity===5&&r5))
  );
  if(pool.length<8){alert('対象が8人未満');return;}
  pool.sort(()=>Math.random()-0.5);
  pool.slice(0,8).forEach((c,i)=>{
    const d=document.createElement('div');
    d.className='card';d.id='c'+i;d.draggable=true;
    d.ondragstart=drag;
    d.innerHTML=`<img src="${img(c.name)}">${c.name}`;
    poolDiv.appendChild(d);
  });
  teamA.innerHTML='';teamB.innerHTML='';
}
</script>
</body>
</html>
