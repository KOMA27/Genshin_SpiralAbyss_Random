<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>
  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
</div>

<div class="center">
  <button id="drawBtn">8人抽選</button>
  <button id="resetTeamBtn" class="reset-btn">編成リセット</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>抽選結果</h2>
    <div id="pool" class="list"></div>
  </div>
  <div class="box">
    <h2>前半</h2>
    <div id="teamA" class="list"></div>
  </div>
  <div class="box">
    <h2>後半</h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<div class="owned-header">
  <h2>キャラ所持設定</h2>
  <button id="resetOwnedBtn" class="reset-btn small">所持リセット</button>
</div>

<div id="grid" class="character-grid"></div>

<script>
let characters = [];
let owned = new Set();
let dragCard = null;

const pool = document.getElementById('pool');
const teamA = document.getElementById('teamA');
const teamB = document.getElementById('teamB');
const grid = document.getElementById('grid');

const icon = n => `./icon/${n}_s.webp`;
const shuffle = a => [...a].sort(() => Math.random() - 0.5);
const sleep = ms => new Promise(r => setTimeout(r, ms));

fetch('./characters.json')
.then(r => r.json())
.then(data => {
  characters = data;
  const saved = JSON.parse(localStorage.getItem('owned'));
  owned = saved ? new Set(saved) : new Set(characters.map(c=>c.name));
  renderGrid();
});

function renderGrid(){
  grid.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char';
    if(!owned.has(c.name)) d.classList.add('off');
    d.innerHTML=`
      <img src="${icon(c.name)}" draggable="false">
      <span>${c.name}</span>
    `;
    d.addEventListener('click',()=>{
      owned.has(c.name) ? owned.delete(c.name) : owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...owned]));
      renderGrid();
    });
    grid.appendChild(d);
  });
}

function createCard(name){
  const d=document.createElement('div');
  d.className='card';
  d.draggable=true;
  d.innerHTML=`<img src="${icon(name)}"><span>${name}</span>`;
  d.ondragstart=()=>dragCard=d;
  return d;
}

async function draw(){
  pool.innerHTML='';
  teamA.innerHTML='';
  teamB.innerHTML='';

  const base = characters.filter(c=>owned.has(c.name));
  if(base.length<8){ alert('抽選対象が8人未満です'); return; }

  const result = shuffle(base).slice(0,8).map(c=>c.name);

  for(const name of result){
    const c = createCard(name);
    c.classList.add('shuffling');
    pool.appendChild(c);
    await sleep(300);
    c.classList.remove('shuffling');
  }
}

drawBtn.onclick=draw;

resetTeamBtn.onclick=()=>{
  pool.innerHTML='';
  teamA.innerHTML='';
  teamB.innerHTML='';
};

resetOwnedBtn.onclick=()=>{
  owned = new Set(characters.map(c=>c.name));
  localStorage.removeItem('owned');
  renderGrid();
};

[pool,teamA,teamB].forEach(list=>{
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault();
    if(!dragCard)return;
    if(list!==pool && list.children.length>=4){
      alert('4人までです');
      return;
    }
    list.appendChild(dragCard);
  };
});
</script>

</body>
</html>
