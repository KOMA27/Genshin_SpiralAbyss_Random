<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>

  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
</div>

<div class="center">
  <button id="drawBtn">8人抽選</button>
  <button class="reset-btn" id="resetBtn">リセット</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>抽選結果</h2>
    <div id="pool" class="list"></div>
  </div>
  <div class="box">
    <h2>前半</h2>
    <div id="teamA" class="list"></div>
  </div>
  <div class="box">
    <h2>後半</h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<h2 class="sub">キャラ所持設定</h2>
<div id="grid" class="character-grid"></div>

<script>
/* ========= SE (Web Audio API) ========= */
let audioCtx;
function playSE(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.type = 'triangle';
  o.frequency.setValueAtTime(1800, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(900, audioCtx.currentTime + 0.08);

  g.gain.setValueAtTime(0.25, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);

  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.08);
}

/* ========= グローバル ========= */
let characters = [];
let owned = new Set();
let dragCard = null;

/* ========= DOM ========= */
const pool = document.getElementById('pool');
const teamA = document.getElementById('teamA');
const teamB = document.getElementById('teamB');
const grid = document.getElementById('grid');

/* ========= JSON ========= */
fetch('./characters.json')
  .then(r => r.json())
  .then(data => {
    characters = data;
    const saved = JSON.parse(localStorage.getItem('owned') || '[]');
    owned = new Set(saved.length ? saved : characters.map(c => c.name));
    renderGrid();
  });

function icon(c){
  return `./icon/${c.name}_s.webp`;
}

/* ========= 所持設定 ========= */
function renderGrid(){
  grid.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char'+(owned.has(c.name)?'':' off');
    d.innerHTML=`<img src="${icon(c)}"><span>${c.name}</span>`;
    d.onclick=()=>{
      owned.has(c.name)?owned.delete(c.name):owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

/* ========= カード ========= */
function createCard(c){
  const d=document.createElement('div');
  d.className='card';
  d.innerHTML=`<img src="${icon(c)}">${c.name}`;
  d.draggable=true;

  d.ondragstart=()=>{
    dragCard=d;
    setTimeout(()=>d.classList.add('dragging'),0);
  };
  d.ondragend=()=>{
    dragCard=null;
    d.classList.remove('dragging');
  };
  return d;
}

/* ========= 抽選 ========= */
document.getElementById('drawBtn').onclick = async ()=>{
  pool.innerHTML = teamA.innerHTML = teamB.innerHTML = '';

  const r4=document.getElementById('r4').checked;
  const r5=document.getElementById('r5').checked;
  const els=[...document.querySelectorAll('.el:checked')].map(e=>e.value);

  let base = characters.filter(c =>
    owned.has(c.name) &&
    els.includes(c.element) &&
    ((c.rarity===4 && r4) || (c.rarity===5 && r5))
  );

  if(base.length < 8){
    alert('抽選対象が8人未満です');
    return;
  }

  const result = shuffle(base).slice(0,8);
  const slots=[];
  const active = Array(8).fill(true);

  pool.innerHTML='';
  for(let i=0;i<8;i++){
    const d=document.createElement('div');
    d.className='card shuffling';
    pool.appendChild(d);
    slots.push(d);
  }

  const timer=setInterval(()=>{
    slots.forEach((s,i)=>{
      if(!active[i]) return;
      const c=base[Math.floor(Math.random()*base.length)];
      s.innerHTML=`<img src="${icon(c)}">${c.name}`;
    });
  },80);

  for(let i=0;i<8;i++){
    await sleep(300);
    active[i]=false;
    playSE();               // ← ★ここでSE
    slots[i].classList.remove('shuffling');
    slots[i].replaceWith(createCard(result[i]));
    slots[i]=pool.children[i];
  }

  clearInterval(timer);
};

/* ========= D&D ========= */
[pool, teamA, teamB].forEach(list=>{
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault();
    if(!dragCard) return;

    if(list!==pool && list.children.length>=4){
      alert('4人までです');
      return;
    }

    list.appendChild(dragCard);

    if(teamA.children.length===4){
      [...pool.children].forEach(c=>teamB.appendChild(c));
    }
    if(teamB.children.length===4){
      [...pool.children].forEach(c=>teamA.appendChild(c));
    }
  };
});

/* ========= リセット ========= */
document.getElementById('resetBtn').onclick=()=>{
  owned=new Set(characters.map(c=>c.name));
  localStorage.removeItem('owned');
  pool.innerHTML=teamA.innerHTML=teamB.innerHTML='';
  renderGrid();
};

/* ========= util ========= */
function shuffle(a){return [...a].sort(()=>Math.random()-0.5);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
</script>

</body>
</html>
