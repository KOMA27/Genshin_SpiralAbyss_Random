<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åŸç¥ æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</h1>

<div class="filter-box">
  <h2 class="sub">æŠ½é¸æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿</h2>
  <div class="filters">
    <label><input type="checkbox" id="r4" checked>â˜…4</label>
    <label><input type="checkbox" id="r5" checked>â˜…5</label>

    <label><input type="checkbox" class="el" value="ç‚" checked>ç‚</label>
    <label><input type="checkbox" class="el" value="æ°´" checked>æ°´</label>
    <label><input type="checkbox" class="el" value="é›·" checked>é›·</label>
    <label><input type="checkbox" class="el" value="æ°·" checked>æ°·</label>
    <label><input type="checkbox" class="el" value="é¢¨" checked>é¢¨</label>
    <label><input type="checkbox" class="el" value="å²©" checked>å²©</label>
    <label><input type="checkbox" class="el" value="è‰" checked>è‰</label>
  </div>
  <div class="center">
    <button id="resetFilterBtn" class="reset-btn">ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<div class="center">
  <button id="drawBtn">æŠ½é¸</button>
  <button id="survivalDrawBtn" class="survival">ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰æŠ½é¸</button>
  <button id="resetTeamBtn" class="reset-btn">ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
  <button id="resetResultBtn" class="reset-btn">æŠ½é¸çµæœãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="supplementInfo" class="supplement-info" style="display:none"></div>

<div id="counter" class="counter" style="display:none"></div>

<div class="drag-area">
  <div class="box">
    <h2>æŠ½é¸çµæœ</h2>
    <div id="pool" class="list"></div>
  </div>

  <div class="box" id="boxA">
    <h2>
      å‰åŠ
      <span id="lockA" class="lock">ğŸ”“</span>
    </h2>
    <div class="center">
      <button id="drawA" class="reset-btn">å‰åŠã®ã¿æŠ½é¸</button>
      <button id="drawASurvival" class="reset-btn survival">å‰åŠã®ã¿ã‚µãƒã‚¤ãƒãƒ«</button>
    </div>
    <div id="teamA" class="list"></div>
  </div>

  <div class="box" id="boxB">
    <h2>
      å¾ŒåŠ
      <span id="lockB" class="lock">ğŸ”“</span>
    </h2>
    <div class="center">
      <button id="drawB" class="reset-btn">å¾ŒåŠã®ã¿æŠ½é¸</button>
      <button id="drawBSurvival" class="reset-btn survival">å¾ŒåŠã®ã¿ã‚µãƒã‚¤ãƒãƒ«</button>
    </div>
    <div id="teamB" class="list"></div>
  </div>
</div>

<h2 class="sub">ã‚­ãƒ£ãƒ©æ‰€æŒè¨­å®š</h2>
<div class="center">
  <button id="resetOwnedBtn" class="reset-btn">æ‰€æŒè¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
  <button id="resetSurvivalBtn" class="reset-btn">ã‚µãƒã‚¤ãƒãƒ«ä½¿ç”¨æ¸ˆãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div id="grid" class="character-grid"></div>

<div class="history">
  <h2>æŠ½é¸å±¥æ­´</h2>
  <div id="history"></div>
</div>

<script>
/* ===== çŠ¶æ…‹ ===== */
let characters=[];
let owned=new Set();
let usedSurvival=new Set();
let dragCard=null;
let lockTeamA=false;
let lockTeamB=false;
let supplementNames=[];

/* ===== DOM ===== */
const pool=document.getElementById('pool');
const teamA=document.getElementById('teamA');
const teamB=document.getElementById('teamB');
const grid=document.getElementById('grid');
const historyEl=document.getElementById('history');
const counter=document.getElementById('counter');
const supplementInfo=document.getElementById('supplementInfo');

const drawBtn=document.getElementById('drawBtn');
const survivalDrawBtn=document.getElementById('survivalDrawBtn');
const drawA=document.getElementById('drawA');
const drawB=document.getElementById('drawB');
const drawASurvival=document.getElementById('drawASurvival');
const drawBSurvival=document.getElementById('drawBSurvival');

const resetFilterBtn=document.getElementById('resetFilterBtn');
const resetTeamBtn=document.getElementById('resetTeamBtn');
const resetResultBtn=document.getElementById('resetResultBtn');

const lockA=document.getElementById('lockA');
const lockB=document.getElementById('lockB');

const icon=n=>`./icon/${n}_s.webp`;

/* ===== åˆæœŸåŒ– ===== */
fetch('./characters.json').then(r=>r.json()).then(data=>{
  characters=data;
  owned=new Set(JSON.parse(localStorage.getItem('owned')||'[]'));
  usedSurvival=new Set(JSON.parse(localStorage.getItem('usedSurvival')||'[]'));
  if(owned.size===0) owned=new Set(characters.map(c=>c.name));
  renderGrid();
  restoreFromURL();
  renderHistory();
});

/* ===== æŠ½é¸æ¡ä»¶ ===== */
function getElements(){
  return [...document.querySelectorAll('.el:checked')].map(e=>e.value);
}
function passElementFilter(c,els){
  return !c.element || els.includes(c.element);
}
function getBaseNormal(){
  const els=getElements();
  return characters.filter(c=>
    owned.has(c.name) &&
    passElementFilter(c,els) &&
    ((c.rarity===4&&r4.checked)||(c.rarity===5&&r5.checked))
  );
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
function createCard(n){
  const d=document.createElement('div');
  d.className='card';
  d.innerHTML=`<img src="${icon(n)}"><span>${n}</span>`;
  d.draggable=true;
  d.ondragstart=()=>dragCard=d;
  d.ondragend=()=>dragCard=null;
  return d;
}

/* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¢å­˜ï¼‰ ===== */
function slotDraw(draw,onEnd){
  pool.innerHTML='';
  const timers=[];
  draw.forEach((_,i)=>{
    const c=createCard(draw[0]);
    c.classList.add('shuffling');
    pool.appendChild(c);
    timers[i]=setInterval(()=>{
      const r=characters[Math.floor(Math.random()*characters.length)].name;
      c.querySelector('img').src=icon(r);
      c.querySelector('span').textContent=r;
    },40);
    setTimeout(()=>{
      clearInterval(timers[i]);
      c.classList.remove('shuffling');
      c.querySelector('img').src=icon(draw[i]);
      c.querySelector('span').textContent=draw[i];
      if(i===draw.length-1&&onEnd)onEnd();
    },400*(i+1));
  });
}

/* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆéƒ¨åˆ†æŠ½é¸ç”¨ï¼‰ ===== */
function slotDrawTo(target,draw,onEnd){
  target.innerHTML='';
  const timers=[];
  draw.forEach((_,i)=>{
    const c=createCard(draw[0]);
    c.classList.add('shuffling');
    target.appendChild(c);
    timers[i]=setInterval(()=>{
      const r=characters[Math.floor(Math.random()*characters.length)].name;
      c.querySelector('img').src=icon(r);
      c.querySelector('span').textContent=r;
    },40);
    setTimeout(()=>{
      clearInterval(timers[i]);
      c.classList.remove('shuffling');
      c.querySelector('img').src=icon(draw[i]);
      c.querySelector('span').textContent=draw[i];
      if(i===draw.length-1&&onEnd)onEnd();
    },400*(i+1));
  });
}

/* ===== å…¨ä½“æŠ½é¸ï¼ˆè£œå……å¯¾å¿œï¼‰ ===== */
function doDraw(isSurvival){
  supplementNames=[];
  supplementInfo.style.display='none';

  if(!lockTeamA) teamA.innerHTML='';
  if(!lockTeamB) teamB.innerHTML='';

  const fixed=[
    ...(lockTeamA?[...teamA.children].map(c=>c.innerText):[]),
    ...(lockTeamB?[...teamB.children].map(c=>c.innerText):[])
  ];

  const base=getBaseNormal().filter(c=>!fixed.includes(c.name));
  const need=8-fixed.length;

  if(isSurvival && getBaseNormal().length<8){
    alert('æŠ½é¸å¯¾è±¡ã‚­ãƒ£ãƒ©ãŒ8äººæœªæº€ã§ã™');
    return;
  }

  let draw=[];
  let supplementCount=0;

  if(isSurvival){
    const unused=base.filter(c=>!usedSurvival.has(c.name));
    if(unused.length>=need){
      draw=[...unused].sort(()=>Math.random()-0.5).slice(0,need);
    }else{
      draw=[...unused];
      supplementCount=need-draw.length;
      const sup=base.filter(c=>!draw.some(d=>d.name===c.name))
        .sort(()=>Math.random()-0.5)
        .slice(0,supplementCount);
      supplementNames=sup.map(c=>c.name);
      draw=[...draw,...sup];
    }
  }else{
    if(base.length<need) return alert('æŠ½é¸å¯¾è±¡ä¸è¶³');
    draw=[...base].sort(()=>Math.random()-0.5).slice(0,need);
  }

  const names=draw.map(c=>c.name);

  slotDraw(names,()=>{
    if(isSurvival){
      names.forEach(n=>usedSurvival.add(n));
      localStorage.setItem('usedSurvival',JSON.stringify([...usedSurvival]));
      updateCounter();
      renderGrid();
    }
    const result=[...fixed,...names];
    saveHistory(result);
    updateURL(result);

    if(supplementCount>0){
      supplementInfo.textContent=`è£œå…… ${supplementCount} äºº`;
      supplementInfo.style.display='block';
    }
  });
}

/* ===== éƒ¨åˆ†æŠ½é¸ ===== */
function drawOneSide(side,isSurvival){
  supplementNames=[];
  supplementInfo.style.display='none';

  const target=side==='A'?teamA:teamB;
  const fixed=side==='A'?teamB:teamA;

  if(side==='A'&&lockTeamA) return alert('å‰åŠãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™');
  if(side==='B'&&lockTeamB) return alert('å¾ŒåŠãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™');

  const fixedNames=[...fixed.children].map(c=>c.innerText);
  const base=getBaseNormal().filter(c=>!fixedNames.includes(c.name));

  if(isSurvival && base.length<4){
    alert('æŠ½é¸å¯¾è±¡ã‚­ãƒ£ãƒ©ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    return;
  }

  let draw=[];
  let supplementCount=0;

  if(isSurvival){
    const unused=base.filter(c=>!usedSurvival.has(c.name));
    if(unused.length>=4){
      draw=[...unused].sort(()=>Math.random()-0.5).slice(0,4);
    }else{
      draw=[...unused];
      supplementCount=4-draw.length;
      const sup=base.filter(c=>!draw.some(d=>d.name===c.name))
        .sort(()=>Math.random()-0.5)
        .slice(0,supplementCount);
      supplementNames=sup.map(c=>c.name);
      draw=[...draw,...sup];
    }
  }else{
    if(base.length<4) return alert('æŠ½é¸å¯¾è±¡ä¸è¶³');
    draw=[...base].sort(()=>Math.random()-0.5).slice(0,4);
  }

  const names=draw.map(c=>c.name);

  slotDrawTo(target,names,()=>{
    target.innerHTML='';
    names.forEach(n=>{
      const card=createCard(n);
      if(supplementNames.includes(n)) card.classList.add('supplement');
      target.appendChild(card);
      if(isSurvival) usedSurvival.add(n);
    });
    localStorage.setItem('usedSurvival',JSON.stringify([...usedSurvival]));
    updateCounter();
    renderGrid();
    if(supplementCount>0){
      supplementInfo.textContent=`è£œå…… ${supplementCount} äºº`;
      supplementInfo.style.display='block';
    }
  });
}

/* ===== D&D ===== */
[pool,teamA,teamB].forEach(list=>{
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault();
    if(!dragCard) return;
    if(list===teamA&&lockTeamA) return;
    if(list===teamB&&lockTeamB) return;
    if((list===teamA||list===teamB)&&list.children.length>=4){
      alert('4äººã¾ã§ã§ã™');
      return;
    }
    list.appendChild(dragCard);
  };
});

/* ===== ãƒ­ãƒƒã‚¯ ===== */
function updateLocks(){
  lockA.textContent=lockTeamA?'ğŸ”’':'ğŸ”“';
  lockB.textContent=lockTeamB?'ğŸ”’':'ğŸ”“';
}
lockA.onclick=()=>{lockTeamA=!lockTeamA;updateLocks();}
lockB.onclick=()=>{lockTeamB=!lockTeamB;updateLocks();}

/* ===== å±¥æ­´ ===== */
function saveHistory(arr){
  let h=JSON.parse(localStorage.getItem('history')||'[]');
  h.unshift({arr,time:Date.now()});
  h=h.slice(0,10);
  localStorage.setItem('history',JSON.stringify(h));
  renderHistory();
}
function renderHistory(){
  historyEl.innerHTML='';
  JSON.parse(localStorage.getItem('history')||'[]').forEach(x=>{
    const d=document.createElement('div');
    d.className='history-item';
    d.onclick=()=>restore(x.arr);
    d.innerHTML=`
      <div class="history-time">${new Date(x.time).toLocaleString()}</div>
      <div class="history-icons">
        ${x.arr.map(n=>`<img src="${icon(n)}">`).join('')}
      </div>`;
    historyEl.appendChild(d);
  });
}
function restore(arr){
  pool.innerHTML=teamA.innerHTML=teamB.innerHTML='';
  arr.forEach(n=>pool.appendChild(createCard(n)));
  updateURL(arr);
}

/* ===== URL ===== */
function updateURL(arr){
  history.replaceState(null,'','?p='+arr.join(','));
}
function restoreFromURL(){
  const q=new URLSearchParams(location.search);
  if(!q.has('p'))return;
  q.get('p').split(',').forEach(n=>pool.appendChild(createCard(n)));
}

/* ===== ãã®ä»– ===== */
function updateCounter(){
  counter.textContent=`æŠ½é¸æ¸ˆã¿ ${usedSurvival.size} / ${getBaseNormal().length}`;
  counter.style.display='block';
}
resetSurvivalBtn.onclick=()=>{
  usedSurvival.clear();
  localStorage.removeItem('usedSurvival');
  counter.style.display='none';
  renderGrid();
};
resetOwnedBtn.onclick=()=>{
  owned=new Set(characters.map(c=>c.name));
  localStorage.removeItem('owned');
  renderGrid();
};
function renderGrid(){
  grid.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char';
    if(!owned.has(c.name)) d.classList.add('off');
    if(usedSurvival.has(c.name)) d.classList.add('used');
    d.innerHTML=`<img src="${icon(c.name)}"><span>${c.name}</span>`;
    d.onclick=()=>{
      owned.has(c.name)?owned.delete(c.name):owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
drawBtn.onclick=()=>doDraw(false);
survivalDrawBtn.onclick=()=>doDraw(true);
drawA.onclick=()=>drawOneSide('A',false);
drawASurvival.onclick=()=>drawOneSide('A',true);
drawB.onclick=()=>drawOneSide('B',false);
drawBSurvival.onclick=()=>drawOneSide('B',true);

resetFilterBtn.onclick=()=>{
  r4.checked=true;
  r5.checked=true;
  document.querySelectorAll('.el').forEach(e=>e.checked=true);
};

resetTeamBtn.onclick=()=>{
  [...teamA.children,...teamB.children].forEach(c=>pool.appendChild(c));
  teamA.innerHTML='';
  teamB.innerHTML='';
  lockTeamA=lockTeamB=false;
  updateLocks();
};

resetResultBtn.onclick=()=>{
  pool.innerHTML=teamA.innerHTML=teamB.innerHTML='';
  lockTeamA=lockTeamB=false;
  updateLocks();
  history.replaceState(null,'',location.pathname);
};
</script>

</body>
</html>
