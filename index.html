<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åŸç¥ æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</h1>

<div class="filter-box">
  <h2>æŠ½é¸æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿</h2>
  <label><input type="checkbox" id="r4" checked>â˜…4</label>
  <label><input type="checkbox" id="r5" checked>â˜…5</label>
  <label><input type="checkbox" class="el" value="ç‚" checked>ç‚</label>
  <label><input type="checkbox" class="el" value="æ°´" checked>æ°´</label>
  <label><input type="checkbox" class="el" value="é›·" checked>é›·</label>
  <label><input type="checkbox" class="el" value="æ°·" checked>æ°·</label>
  <label><input type="checkbox" class="el" value="é¢¨" checked>é¢¨</label>
  <label><input type="checkbox" class="el" value="å²©" checked>å²©</label>
  <label><input type="checkbox" class="el" value="è‰" checked>è‰</label>
</div>

<div class="center">
  <button id="drawBtn">æŠ½é¸</button>
  <button id="survivalDrawBtn">ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰æŠ½é¸</button>
  <button id="resetTeamBtn">ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
  <button id="resetResultBtn">æŠ½é¸çµæœãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="counter" style="display:none"></div>

<div class="drag-area">
  <div class="box">
    <h2>æŠ½é¸çµæœ</h2>
    <div id="pool" class="list"></div>
  </div>

  <div class="box" id="boxA">
    <h2>å‰åŠ <span id="lockA">ğŸ”“</span></h2>
    <div id="teamA" class="list"></div>
  </div>

  <div class="box" id="boxB">
    <h2>å¾ŒåŠ <span id="lockB">ğŸ”“</span></h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<h2>ã‚­ãƒ£ãƒ©æ‰€æŒè¨­å®š</h2>
<button id="resetOwnedBtn">æ‰€æŒè¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
<button id="resetSurvivalBtn">ã‚µãƒã‚¤ãƒãƒ«ä½¿ç”¨æ¸ˆãƒªã‚»ãƒƒãƒˆ</button>
<div id="grid" class="character-grid"></div>

<h2>æŠ½é¸å±¥æ­´</h2>
<div id="history"></div>

<script>
let characters=[];
let owned=new Set();
let usedSurvival=new Set();
let dragCard=null;
let lockTeamA=false;
let lockTeamB=false;

const pool=document.getElementById('pool');
const teamA=document.getElementById('teamA');
const teamB=document.getElementById('teamB');
const boxA=document.getElementById('boxA');
const boxB=document.getElementById('boxB');
const counter=document.getElementById('counter');

const icon=n=>`./icon/${n}_s.webp`;

fetch('./characters.json').then(r=>r.json()).then(data=>{
  characters=data;
  owned=new Set(JSON.parse(localStorage.getItem('owned')||'[]'));
  usedSurvival=new Set(JSON.parse(localStorage.getItem('usedSurvival')||'[]'));
  if(owned.size===0) owned=new Set(characters.map(c=>c.name));
  renderGrid();
  restoreFromURL();
  renderHistory();
});

function createCard(n){
  const d=document.createElement('div');
  d.className='card';
  d.innerHTML=`<img src="${icon(n)}"><span>${n}</span>`;
  d.draggable=true;
  d.ondragstart=()=>dragCard=d;
  d.ondragend=()=>dragCard=null;
  return d;
}

/* ===== D&D ===== */
[pool,teamA,teamB].forEach(list=>{
  list.ondragover=e=>e.preventDefault();
  list.ondrop=e=>{
    e.preventDefault();
    if(!dragCard) return;
    if(list===teamA&&lockTeamA) return;
    if(list===teamB&&lockTeamB) return;
    if((list===teamA||list===teamB)&&list.children.length>=4) return;
    list.appendChild(dragCard);
    autoFill();
  };
});

/* 4äººç¢ºå®šæ™‚ã®è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ */
function autoFill(){
  if(teamA.children.length===4 && teamB.children.length<4){
    while(pool.children.length && teamB.children.length<4)
      teamB.appendChild(pool.firstChild);
  }
  if(teamB.children.length===4 && teamA.children.length<4){
    while(pool.children.length && teamA.children.length<4)
      teamA.appendChild(pool.firstChild);
  }
}

/* ===== ãƒ­ãƒƒã‚¯ ===== */
function updateLocks(){
  lockA.textContent=lockTeamA?'ğŸ”’':'ğŸ”“';
  lockB.textContent=lockTeamB?'ğŸ”’':'ğŸ”“';
  boxA.classList.toggle('locked',lockTeamA);
  boxB.classList.toggle('locked',lockTeamB);
}
lockA.onclick=()=>{lockTeamA=!lockTeamA;updateLocks();}
lockB.onclick=()=>{lockTeamB=!lockTeamB;updateLocks();}

/* ===== æŠ½é¸ ===== */
function slotDraw(draw,onEnd){
  pool.innerHTML='';
  draw.forEach((_,i)=>{
    const c=createCard(draw[0]);
    c.classList.add('shuffling');
    pool.appendChild(c);
    const t=setInterval(()=>{
      const r=characters[Math.floor(Math.random()*characters.length)].name;
      c.querySelector('img').src=icon(r);
      c.querySelector('span').textContent=r;
    },40);
    setTimeout(()=>{
      clearInterval(t);
      c.classList.remove('shuffling');
      c.querySelector('img').src=icon(draw[i]);
      c.querySelector('span').textContent=draw[i];
      if(i===draw.length-1&&onEnd)onEnd();
    },400*(i+1));
  });
}

function doSurvivalDraw(){
  if(pool.children.length) return alert('æŠ½é¸çµæœãŒç©ºã®æ™‚ã®ã¿å¯èƒ½ã§ã™');

  const unused=characters.filter(c=>owned.has(c.name)&&!usedSurvival.has(c.name));
  let result=[...unused].slice(0,8).map(c=>c.name);

  if(result.length<8){
    const rest=characters.filter(c=>owned.has(c.name)&&!result.includes(c.name));
    result.push(...rest.sort(()=>Math.random()-0.5).slice(0,8-result.length).map(c=>c.name));
  }

  slotDraw(result,()=>{
    result.forEach(n=>usedSurvival.add(n));
    localStorage.setItem('usedSurvival',JSON.stringify([...usedSurvival]));
    counter.textContent=`æŠ½é¸æ¸ˆã¿ ${usedSurvival.size}/${characters.filter(c=>owned.has(c.name)).length}`;
    counter.style.display='block';
    renderGrid();
    saveHistory(result);
    updateURL(result);
  });
}

survivalDrawBtn.onclick=doSurvivalDraw;

/* ===== æ—¢å­˜é–¢æ•°ï¼ˆå±¥æ­´ãƒ»URLãƒ»ãƒªã‚»ãƒƒãƒˆãƒ»ã‚°ãƒªãƒƒãƒ‰ï¼‰ã¯å…ƒã®ã¾ã¾ ===== */
/* ã“ã“ã¯å‰å›æ­£å¸¸å‹•ä½œã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã¨åŒä¸€ã§ã™ */

</script>
</body>
</html>
