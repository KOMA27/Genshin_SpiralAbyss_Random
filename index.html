<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<style>
body{font-family:sans-serif;background:#f6f6f6;padding:20px}
h1{text-align:center}
button{padding:8px 16px;font-size:15px;cursor:pointer;margin:6px}
.filters{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px}
.filters label{background:#fff;padding:6px 10px;border-radius:6px}
.character-grid{display:grid;grid-template-columns:repeat(auto-fill,80px);gap:12px;margin:15px 0}
.char{text-align:center;cursor:pointer}
.char img{width:72px;height:72px;border-radius:10px;object-fit:cover}
.char.off img{filter:grayscale(100%) brightness(60%)}
.char span{font-size:11px}
.teams{display:flex;gap:20px}
.team{background:#fff;padding:10px;border-radius:10px;width:50%}
.team h2{border-bottom:2px solid #333}
li{display:flex;align-items:center;margin:6px 0}
li img{width:48px;height:48px;margin-right:6px;border-radius:8px;object-fit:cover}
</style>
</head>
<body>

<h1>原神 深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>
  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
</div>

<div style="text-align:center">
  <button onclick="draw()">抽選</button>
  <button onclick="draw()">再抽選</button>
</div>

<div id="grid" class="character-grid"></div>

<div class="teams">
  <div class="team"><h2>前半</h2><ul id="t1"></ul></div>
  <div class="team"><h2>後半</h2><ul id="t2"></ul></div>
</div>

<script>
const WIKI_IMG = 'https://wikiwiki.jp/genshinwiki/画像/';

let characters = [];
let owned = new Set();

/* ---------- 初期化 ---------- */
fetch('characters.json')
  .then(res => {
    if (!res.ok) throw new Error('characters.json が見つかりません');
    return res.json();
  })
  .then(data => {
    if (!Array.isArray(data)) {
      throw new Error('characters.json が配列ではありません');
    }

    characters = data;

    const saved = JSON.parse(localStorage.getItem('owned'));
    owned = new Set(saved ?? characters.map(c => c.name));

    renderGrid();
  })
  .catch(err => {
    console.error(err);
    alert('キャラデータの読み込みに失敗しました');
  });

/* ---------- 共通 ---------- */
function save(){
  localStorage.setItem('owned', JSON.stringify([...owned]));
}

function imgUrl(name){
  return WIKI_IMG + encodeURIComponent(name) + '.webp';
}

function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

/* ---------- キャラ一覧 ---------- */
function renderGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  characters.forEach(c => {
    const div = document.createElement('div');
    div.className = 'char' + (owned.has(c.name) ? '' : ' off');

    div.onclick = () => {
      owned.has(c.name) ? owned.delete(c.name) : owned.add(c.name);
      save();
      renderGrid();
    };

    div.innerHTML = `
      <img src="${imgUrl(c.name)}" loading="lazy">
      <span>${c.name}</span>
    `;
    grid.appendChild(div);
  });
}

/* ---------- 抽選 ---------- */
function draw(){
  const elements = [...document.querySelectorAll('.el:checked')].map(e => e.value);
  const allow4 = document.getElementById('r4').checked;
  const allow5 = document.getElementById('r5').checked;

  const pool = characters.filter(c =>
    owned.has(c.name) &&
    elements.includes(c.element) &&
    ((c.rarity === 4 && allow4) || (c.rarity === 5 && allow5))
  );

  if(pool.length < 8){
    alert('抽選対象キャラが8人未満です');
    return;
  }

  shuffle(pool);
  const picked = pool.slice(0, 8);

  document.getElementById('t1').innerHTML = '';
  document.getElementById('t2').innerHTML = '';

  picked.slice(0, 4).forEach(c => addResult('t1', c));
  picked.slice(4).forEach(c => addResult('t2', c));
}

function addResult(id, c){
  const li = document.createElement('li');
  li.innerHTML = `<img src="${imgUrl(c.name)}">${c.name}`;
  document.getElementById(id).appendChild(li);
}
</script>

</body>
</html>
