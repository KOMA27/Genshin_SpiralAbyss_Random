<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åŸç¥ æ·±å¢ƒèºæ—‹ æŠ½é¸ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>æ·±å¢ƒèºæ—‹ ãƒ©ãƒ³ãƒ€ãƒ ç·¨æˆ</h1>

<section>
  <h2>æ‰€æŒã‚­ãƒ£ãƒ©</h2>
  <div id="characterGrid" class="character-grid"></div>
  <button id="resetOwned" class="sub-btn">æ‰€æŒã‚­ãƒ£ãƒ©ãƒªã‚»ãƒƒãƒˆ</button>
</section>

<div class="center">
  <button id="drawBtn">æŠ½é¸</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>å‰åŠ <button class="lock-btn" data-team="a">ğŸ”“</button></h2>
    <div id="teamA" class="list"></div>
  </div>
  <div class="box">
    <h2>å¾ŒåŠ <button class="lock-btn" data-team="b">ğŸ”“</button></h2>
    <div id="teamB" class="list"></div>
  </div>
</div>

<div class="center">
  <button id="resetTeams" class="sub-btn">ç·¨æˆãƒªã‚»ãƒƒãƒˆ</button>
</div>

<section>
  <div class="history-header">
    <h2>æŠ½é¸å±¥æ­´</h2>
    <button id="resetHistory" class="sub-btn">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div id="history" class="history-grid"></div>
</section>

<script>
/* =====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
===================== */
let characters = [];
let owned = [];
let history = JSON.parse(localStorage.getItem("history") || "[]");

let result = [];
let teamA = [];
let teamB = [];
let lockA = false;
let lockB = false;
let animating = false;

/* =====================
   åˆæœŸãƒ­ãƒ¼ãƒ‰
===================== */
fetch("./characters.json")
  .then(r => r.json())
  .then(data => {
    characters = data;

    const savedOwned = JSON.parse(localStorage.getItem("owned"));
    owned = Array.isArray(savedOwned) && savedOwned.length
      ? savedOwned
      : characters.map(c => c.name); // â˜… åˆæœŸã¯å…¨ON

    localStorage.setItem("owned", JSON.stringify(owned));

    renderOwned();
    renderHistory();
    restoreFromURL();
  });

/* =====================
   æ‰€æŒã‚­ãƒ£ãƒ©
===================== */
const grid = document.getElementById("characterGrid");

function renderOwned(){
  grid.innerHTML = "";
  characters.forEach(c => {
    const div = document.createElement("div");
    div.className = "char" + (owned.includes(c.name) ? "" : " off");
    div.innerHTML = `
      <img src="./icon/${c.name}_s.webp">
      <span>${c.name}</span>
    `;
    div.onclick = () => {
      owned = owned.includes(c.name)
        ? owned.filter(n => n !== c.name)
        : [...owned, c.name];
      localStorage.setItem("owned", JSON.stringify(owned));
      renderOwned();
    };
    grid.appendChild(div);
  });
}

/* =====================
   æŠ½é¸
===================== */
drawBtn.onclick = async () => {
  if(animating) return;
  if(owned.length < 8){
    alert("æ‰€æŒã‚­ãƒ£ãƒ©ãŒ8äººæœªæº€ã§ã™");
    return;
  }

  animating = true;
  drawBtn.disabled = true;

  result = [];
  teamA = [];
  teamB = [];
  renderTeams();

  const pool = [...owned];
  shuffle(pool);
  const selected = pool.slice(0,8);

  history.unshift({
    time: new Date().toLocaleString(),
    chars: selected
  });
  history = history.slice(0,10);
  localStorage.setItem("history", JSON.stringify(history));
  renderHistory();

  history.replaceState(null,"","?r="+encodeURIComponent(selected.join(",")));

  for(const name of selected){
    await sleep(300);
    result.push(name);
    autoFill();
    renderTeams();
  }

  animating = false;
  drawBtn.disabled = false;
};

/* =====================
   ç·¨æˆ
===================== */
function autoFill(){
  if(teamA.length < 4){
    const n = result.find(x => !teamA.includes(x) && !teamB.includes(x));
    if(n) teamA.push(n);
  } else if(teamB.length < 4){
    const n = result.find(x => !teamA.includes(x) && !teamB.includes(x));
    if(n) teamB.push(n);
  }
}

function renderTeams(){
  renderTeam("teamA", teamA, lockA);
  renderTeam("teamB", teamB, lockB);
}

function renderTeam(id, arr, locked){
  const el = document.getElementById(id);
  el.innerHTML = "";
  arr.forEach((n,i)=>{
    const d=document.createElement("div");
    d.className="card";
    d.draggable=!locked;
    d.innerHTML=`<img src="./icon/${n}_s.webp"><span>${n}</span>`;
    d.ondragstart=e=>{
      e.dataTransfer.setData("text",`${id},${i}`);
    };
    el.appendChild(d);
  });

  el.ondragover=e=>e.preventDefault();
  el.ondrop=e=>{
    if(locked) return;
    const [from,idx]=e.dataTransfer.getData("text").split(",");
    const src = from==="teamA"?teamA:teamB;
    const dst = id==="teamA"?teamA:teamB;
    if(dst.length>=4){
      alert("4äººã¾ã§ã§ã™");
      return;
    }
    dst.push(src.splice(idx,1)[0]);
    renderTeams();
  };
}

/* =====================
   ãƒ­ãƒƒã‚¯
===================== */
document.querySelectorAll(".lock-btn").forEach(btn=>{
  btn.onclick=()=>{
    if(btn.dataset.team==="a"){
      lockA=!lockA;
      btn.textContent=lockA?"ğŸ”’":"ğŸ”“";
    }else{
      lockB=!lockB;
      btn.textContent=lockB?"ğŸ”’":"ğŸ”“";
    }
  };
});

/* =====================
   å±¥æ­´
===================== */
function renderHistory(){
  const h=document.getElementById("history");
  h.innerHTML="";
  history.forEach(e=>{
    const d=document.createElement("div");
    d.className="history-item";
    d.innerHTML=`
      <div class="time">${e.time}</div>
      <div class="icons">
        ${e.chars.map(n=>`<img src="./icon/${n}_s.webp">`).join("")}
      </div>
    `;
    h.appendChild(d);
  });
}

/* =====================
   URLå¾©å…ƒ
===================== */
function restoreFromURL(){
  const r = new URLSearchParams(location.search).get("r");
  if(!r) return;
  result = r.split(",");
  teamA = result.slice(0,4);
  teamB = result.slice(4,8);
  renderTeams();
}

/* =====================
   ãƒªã‚»ãƒƒãƒˆ
===================== */
resetOwned.onclick = () => {
  owned = characters.map(c=>c.name); // â˜… å…¨ONã«æˆ»ã™
  localStorage.setItem("owned", JSON.stringify(owned));
  renderOwned();
};

resetTeams.onclick = () => {
  result = [];
  teamA = [];
  teamB = [];
  renderTeams();
};

resetHistory.onclick = () => {
  history = [];
  localStorage.removeItem("history");
  renderHistory();
};

/* =====================
   Utils
===================== */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
</script>
</body>
</html>
