<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>原神 深境螺旋 抽選ツール</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>深境螺旋 抽選ツール</h1>

<div class="filters">
  <label><input type="checkbox" id="r4" checked>★4</label>
  <label><input type="checkbox" id="r5" checked>★5</label>

  <label><input type="checkbox" class="el" value="炎" checked>炎</label>
  <label><input type="checkbox" class="el" value="水" checked>水</label>
  <label><input type="checkbox" class="el" value="雷" checked>雷</label>
  <label><input type="checkbox" class="el" value="氷" checked>氷</label>
  <label><input type="checkbox" class="el" value="風" checked>風</label>
  <label><input type="checkbox" class="el" value="岩" checked>岩</label>
  <label><input type="checkbox" class="el" value="草" checked>草</label>
</div>

<div class="center">
  <button onclick="draw()">8人抽選</button>
  <button class="reset-btn" onclick="resetAll()">リセット</button>
</div>

<div class="drag-area">
  <div class="box">
    <h2>抽選結果</h2>
    <div id="pool" class="list" ondragover="allowDrop(event)" ondrop="drop(event,'pool')"></div>
  </div>
  <div class="box">
    <h2>前半</h2>
    <div id="teamA" class="list" ondragover="allowDrop(event)" ondrop="drop(event,'teamA')"></div>
  </div>
  <div class="box">
    <h2>後半</h2>
    <div id="teamB" class="list" ondragover="allowDrop(event)" ondrop="drop(event,'teamB')"></div>
  </div>
</div>

<h2 style="text-align:center;margin-top:30px">キャラ所持設定</h2>
<div id="grid" class="character-grid"></div>

<script>
let characters=[];
let owned=new Set();

const pool=document.getElementById('pool');
const teamA=document.getElementById('teamA');
const teamB=document.getElementById('teamB');
const grid=document.getElementById('grid');

/* ---------- 初期ロード ---------- */
fetch('./characters.json')
  .then(r=>r.json())
  .then(data=>{
    characters=data;

    owned=new Set(JSON.parse(localStorage.getItem('owned')||'[]'));
    if(owned.size===0){
      characters.forEach(c=>owned.add(c.name));
    }
    renderGrid();
  });

function img(c){
  return `./icon/${c.name}_s.webp`;
}

/* ---------- UI ---------- */
function renderGrid(){
  grid.innerHTML='';
  characters.forEach(c=>{
    const d=document.createElement('div');
    d.className='char'+(owned.has(c.name)?'':' off');
    d.innerHTML=`<img src="${img(c)}"><span>${c.name}</span>`;
    d.onclick=()=>{
      owned.has(c.name)?owned.delete(c.name):owned.add(c.name);
      localStorage.setItem('owned',JSON.stringify([...owned]));
      renderGrid();
    };
    grid.appendChild(d);
  });
}

/* ---------- 抽選 ---------- */
async function draw(){
  pool.innerHTML=teamA.innerHTML=teamB.innerHTML='';

  const r4=document.getElementById('r4').checked;
  const r5=document.getElementById('r5').checked;
  const els=[...document.querySelectorAll('.el:checked')].map(e=>e.value);

  const base=characters.filter(c=>
    owned.has(c.name)&&els.includes(c.element)&&
    ((c.rarity===4&&r4)||(c.rarity===5&&r5))
  );

  if(base.length<8){
    alert('抽選対象が8人未満です');
    return;
  }

  // 抽選演出
  for(let i=0;i<15;i++){
    pool.innerHTML='';
    base.sort(()=>Math.random()-0.5).slice(0,8).forEach(c=>{
      const d=document.createElement('div');
      d.className='card shuffling';
      d.innerHTML=`<img src="${img(c)}">${c.name}`;
      pool.appendChild(d);
    });
    await new Promise(r=>setTimeout(r,80));
  }

  // 確定
  pool.innerHTML='';
  base.sort(()=>Math.random()-0.5).slice(0,8).forEach((c,i)=>{
    const d=document.createElement('div');
    d.className='card';
    d.id='c'+i;
    d.draggable=true;
    d.ondragstart=drag;
    d.innerHTML=`<img src="${img(c)}">${c.name}`;
    pool.appendChild(d);
  });
}

/* ---------- リセット ---------- */
function resetAll(){
  owned=new Set(characters.map(c=>c.name));
  localStorage.removeItem('owned');
  pool.innerHTML=teamA.innerHTML=teamB.innerHTML='';
  renderGrid();
}

/* ---------- D&D ---------- */
function drag(ev){ev.dataTransfer.setData('text',ev.target.id);}
function allowDrop(ev){ev.preventDefault();}
function drop(ev,target){
  ev.preventDefault();
  const id=ev.dataTransfer.getData('text');
  const el=document.getElementById(id);
  const bo
